<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Physics Topic D Practice App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            min-height: 90vh;
        }

        /* Main Content Area (Left Column) */
        .main-content {
            flex: 0 0 70%;
            padding: 40px;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .question-meta {
            display: flex;
            gap: 20px;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .topic-badge {
            background: #667eea;
            color: white;
        }

        .type-badge {
            background: #764ba2;
            color: white;
        }

        .marks-badge {
            background: #48bb78;
            color: white;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .timer.warning {
            color: #e53e3e;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .question-container {
            flex: 1;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
        }

        .answer-area {
            margin-bottom: 20px;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .option-button:hover {
            background: #f7fafc;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option-button.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .answer-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit {
            background: #48bb78;
            color: white;
        }

        .btn-submit:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-submit:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-next {
            background: #667eea;
            color: white;
        }

        .btn-next:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .feedback-area {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .feedback-area.show {
            display: block;
        }

        .feedback-area.correct {
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
        }

        .feedback-area.incorrect {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
        }

        .feedback-area.grading {
            background: #feebc8;
            border-left: 4px solid #ed8936;
        }

        .feedback-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .feedback-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .flash-correct {
            animation: flashGreen 0.5s ease;
        }

        .flash-incorrect {
            animation: flashRed 0.5s ease;
        }

        @keyframes flashGreen {
            0%, 100% { background: white; }
            50% { background: #c6f6d5; }
        }

        @keyframes flashRed {
            0%, 100% { background: white; }
            50% { background: #fed7d7; }
        }

        /* Sidebar (Right Column) */
        .sidebar {
            flex: 0 0 30%;
            background: #2d3748;
            color: white;
            padding: 30px;
            overflow-y: auto;
            max-height: 90vh;
        }

        .sidebar h2 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .sidebar h3 {
            font-size: 1.1em;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #a0aec0;
        }

        .sidebar table {
            width: 100%;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .sidebar table td {
            padding: 5px;
            border-bottom: 1px solid #4a5568;
        }

        .sidebar table td:first-child {
            font-weight: bold;
            color: #cbd5e0;
        }

        .equation {
            background: #1a202c;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .equation-label {
            color: #a0aec0;
            font-size: 0.85em;
            margin-bottom: 3px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a202c;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            .main-content, .sidebar {
                flex: 1 1 100%;
            }
            .sidebar {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <div class="header">
                <h1>IB Physics Topic D Practice</h1>
                <div class="subtitle">Fields: Gravitational, Electric & Magnetic</div>
            </div>

            <div class="question-info">
                <div class="question-meta">
                    <span class="badge topic-badge" id="topicBadge">D.1</span>
                    <span class="badge type-badge" id="typeBadge">Multiple Choice</span>
                    <span class="badge marks-badge" id="marksBadge">1 Mark</span>
                </div>
                <div class="timer" id="timer">90</div>
            </div>

            <div class="question-container">
                <div class="question-text" id="questionText">Loading question...</div>
                <div class="answer-area" id="answerArea"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-submit" id="submitBtn">Submit Answer</button>
                <button class="btn btn-next" id="nextBtn">Next Question</button>
            </div>

            <div class="feedback-area" id="feedbackArea">
                <div class="feedback-title" id="feedbackTitle"></div>
                <div class="feedback-content" id="feedbackContent"></div>
            </div>
        </div>

        <!-- Sidebar Reference Area -->
        <div class="sidebar">
            <h2>Reference Data</h2>

            <h3>Fundamental Constants</h3>
            <table>
                <tr><td>G</td><td>6.67 × 10⁻¹¹ N m² kg⁻²</td></tr>
                <tr><td>g</td><td>9.81 m s⁻² (on Earth)</td></tr>
                <tr><td>e</td><td>1.60 × 10⁻¹⁹ C</td></tr>
                <tr><td>mₑ</td><td>9.11 × 10⁻³¹ kg</td></tr>
                <tr><td>mₚ</td><td>1.673 × 10⁻²⁷ kg</td></tr>
                <tr><td>ε₀</td><td>8.85 × 10⁻¹² F m⁻¹</td></tr>
                <tr><td>μ₀</td><td>4π × 10⁻⁷ H m⁻¹</td></tr>
                <tr><td>c</td><td>3.00 × 10⁸ m s⁻¹</td></tr>
            </table>

            <h3>SI Multipliers</h3>
            <table>
                <tr><td>pico (p)</td><td>10⁻¹²</td></tr>
                <tr><td>nano (n)</td><td>10⁻⁹</td></tr>
                <tr><td>micro (μ)</td><td>10⁻⁶</td></tr>
                <tr><td>milli (m)</td><td>10⁻³</td></tr>
                <tr><td>kilo (k)</td><td>10³</td></tr>
                <tr><td>mega (M)</td><td>10⁶</td></tr>
                <tr><td>giga (G)</td><td>10⁹</td></tr>
                <tr><td>tera (T)</td><td>10¹²</td></tr>
            </table>

            <h2>Topic D Equations</h2>

            <h3>D.1 Gravitational Fields</h3>
            <div class="equation-label">Standard level and higher level:</div>
            <div class="equation">F = Gm₁m₂/r²</div>
            <div class="equation">g = F/m = GM/r²</div>

            <div class="equation-label">Additional higher level:</div>
            <div class="equation">Eₚ = -Gm₁m₂/r</div>
            <div class="equation">Vg = -GM/r</div>
            <div class="equation">g = -ΔVg/Δr</div>
            <div class="equation">W = mΔVg</div>
            <div class="equation">v_esc = √(2GM/r)</div>
            <div class="equation">v_orbital = √(GM/r)</div>

            <h3>D.2 Electric and Magnetic Fields</h3>
            <div class="equation-label">Standard level and higher level:</div>
            <div class="equation">F = kq₁q₂/r² where k = 1/(4πε₀)</div>
            <div class="equation">E = F/q</div>
            <div class="equation">E = V/d</div>

            <div class="equation-label">Additional higher level:</div>
            <div class="equation">Eₚ = kq₁q₂/r</div>
            <div class="equation">Ve = kQ/r</div>
            <div class="equation">E = -ΔVe/Δr</div>
            <div class="equation">W = qΔVe</div>

            <h3>D.3 Motion in Electromagnetic Fields</h3>
            <div class="equation-label">Standard level and higher level:</div>
            <div class="equation">F = qvB sin θ</div>
            <div class="equation">F = BIL sin θ</div>
            <div class="equation">F/L = μ₀I₁I₂/(2πr)</div>
        </div>
    </div>

    <script>
        // ====================================================================
        // DATA STRUCTURE - User should populate this with questions from PDFs
        // ====================================================================
        // Source PDFs:
        // - 'Topic D - Paper 2 Exam Questions.pdf' for question text, options, marks
        // - 'Topic D - Answers.pdf' for answer and fullAnswer
        //
        // IMPORTANT: Only add questions from D.1, D.2, and D.3 topics.
        // Do NOT include D.4 questions as they are not covered in this app.

        // Questions will be loaded from markdown files
        let questions = [];

        // ====================================================================
        // LOAD QUESTIONS FROM MARKDOWN FILES
        // ====================================================================
        async function loadQuestionsFromMarkdown() {
            try {
                // Load Multiple Choice questions
                const mcResponse = await fetch('Topic D multiple choice.md');
                const mcText = await mcResponse.text();
                const mcQuestions = parseMultipleChoiceQuestions(mcText);

                // Load Paper 2 questions
                const paper2Response = await fetch('Topic D paper 2.md');
                const paper2Text = await paper2Response.text();
                const paper2Questions = parsePaper2Questions(paper2Text);

                // Combine all questions
                questions = [...mcQuestions, ...paper2Questions];

                console.log(`Loaded ${mcQuestions.length} multiple choice questions`);
                console.log(`Loaded ${paper2Questions.length} Paper 2 questions`);
                console.log(`Total: ${questions.length} questions`);

                return questions;
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Please make sure the markdown files are in the same directory.');
                return [];
            }
        }

        // ====================================================================
        // PARSE MULTIPLE CHOICE QUESTIONS FROM MARKDOWN
        // ====================================================================
        function parseMultipleChoiceQuestions(text) {
            const questions = [];
            const lines = text.split('\n');
            let currentQuestion = null;
            let questionText = '';
            let options = [];
            let collectingOptions = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Check if line starts with a number (question number)
                const questionMatch = line.match(/^(\d+)\s+(.+)/);

                if (questionMatch && !line.match(/^(\d+)\s*$/)) {
                    // Save previous question if exists
                    if (currentQuestion !== null && questionText) {
                        questions.push({
                            id: currentQuestion,
                            topic: detectTopic(questionText),
                            type: 'mc',
                            text: questionText.trim(),
                            marks: 1,
                            options: options.length > 0 ? options : ['A', 'B', 'C', 'D'],
                            answer: options.length > 0 ? options[0] : 'A',
                            fullAnswer: 'Multiple choice question. Select the correct answer.'
                        });
                    }

                    // Start new question
                    currentQuestion = parseInt(questionMatch[1]);
                    questionText = questionMatch[2];
                    options = [];
                    collectingOptions = true;
                } else if (line.match(/^[A-D]\s+/) && collectingOptions) {
                    // Collect option
                    options.push(line.substring(2).trim());
                } else if (currentQuestion !== null && line) {
                    // Continue building current question
                    questionText += '\n' + line;
                }
            }

            // Add last question
            if (currentQuestion !== null && questionText) {
                questions.push({
                    id: currentQuestion + 1000, // Offset to avoid ID conflicts
                    topic: detectTopic(questionText),
                    type: 'mc',
                    text: questionText.trim(),
                    marks: 1,
                    options: options.length > 0 ? options : ['A', 'B', 'C', 'D'],
                    answer: options.length > 0 ? options[0] : 'A',
                    fullAnswer: 'Multiple choice question. Select the correct answer.'
                });
            }

            return questions;
        }

        // ====================================================================
        // PARSE PAPER 2 QUESTIONS FROM MARKDOWN
        // ====================================================================
        function parsePaper2Questions(text) {
            const questions = [];
            // Split by question numbers
            const questionMatches = text.split(/####\s+(\d+)\./);

            // Process in pairs (question number, question content)
            for (let i = 1; i < questionMatches.length; i += 2) {
                const questionNumber = questionMatches[i];
                const questionContent = questionMatches[i + 1];

                if (questionContent && questionContent.trim()) {
                    // Split question from answer
                    const parts = questionContent.split(/Question \d+ Answers/);
                    const questionText = parts[0] ? parts[0].trim() : '';
                    const answerText = parts[1] ? parts[1].trim() : '';

                    if (questionText) {
                        // Extract marks (look for [X] pattern)
                        const marksMatch = questionText.match(/\[(\d+)\]/);
                        const marks = marksMatch ? parseInt(marksMatch[1]) : 3;

                        questions.push({
                            id: parseInt(questionNumber),
                            topic: detectTopic(questionText),
                            type: 'fr',
                            text: questionText,
                            marks: marks,
                            options: null,
                            answer: null,
                            fullAnswer: answerText || 'See marking scheme for full answer.'
                        });
                    }
                }
            }

            return questions;
        }

        // ====================================================================
        // DETECT TOPIC FROM QUESTION TEXT
        // ====================================================================
        function detectTopic(text) {
            const lowerText = text.toLowerCase();

            if (lowerText.includes('gravit') || lowerText.includes('orbit') ||
                lowerText.includes('kepler') || lowerText.includes('planet') ||
                lowerText.includes('satellite') || lowerText.includes('escape')) {
                return 'D.1';
            }
            if (lowerText.includes('electric') || lowerText.includes('charge') ||
                lowerText.includes('potential') || lowerText.includes('coulomb')) {
                return 'D.2';
            }
            if (lowerText.includes('magnetic') || lowerText.includes('flux') ||
                lowerText.includes('induc') || lowerText.includes('emf') ||
                lowerText.includes('faraday') || lowerText.includes('current')) {
                return 'D.3';
            }

            return 'D.1'; // Default
        }

        // ====================================================================
        // APPLICATION STATE
        // ====================================================================
        let currentQuestionIndex = 0;
        let shuffledQuestions = [];
        let timerInterval = null;
        let timeRemaining = 0;
        let userAnswer = null;
        let hasSubmitted = false;

        // ====================================================================
        // DOM ELEMENTS
        // ====================================================================
        const mainContent = document.getElementById('mainContent');
        const topicBadge = document.getElementById('topicBadge');
        const typeBadge = document.getElementById('typeBadge');
        const marksBadge = document.getElementById('marksBadge');
        const timerDisplay = document.getElementById('timer');
        const questionText = document.getElementById('questionText');
        const answerArea = document.getElementById('answerArea');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        const feedbackArea = document.getElementById('feedbackArea');
        const feedbackTitle = document.getElementById('feedbackTitle');
        const feedbackContent = document.getElementById('feedbackContent');

        // ====================================================================
        // INITIALIZATION
        // ====================================================================
        async function init() {
            // Show loading message
            questionText.textContent = 'Loading questions from markdown files...';

            // Load questions from markdown files
            await loadQuestionsFromMarkdown();

            // Check if questions were loaded
            if (questions.length === 0) {
                questionText.textContent = 'Error: No questions were loaded. Please check that the markdown files are in the same directory.';
                return;
            }

            // Filter to only include D.1, D.2, and D.3 questions
            const filteredQuestions = questions.filter(q =>
                q.topic === 'D.1' || q.topic === 'D.2' || q.topic === 'D.3'
            );

            // Shuffle questions array
            shuffledQuestions = [...filteredQuestions].sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;

            // Set up event listeners
            submitBtn.addEventListener('click', handleSubmit);
            nextBtn.addEventListener('click', handleNext);

            // Display first question
            displayQuestion();
        }

        // ====================================================================
        // DISPLAY QUESTION
        // ====================================================================
        function displayQuestion() {
            const question = shuffledQuestions[currentQuestionIndex];

            // Reset state
            hasSubmitted = false;
            userAnswer = null;
            feedbackArea.classList.remove('show', 'correct', 'incorrect', 'grading');
            submitBtn.disabled = false;

            // Update badges
            topicBadge.textContent = question.topic;
            typeBadge.textContent = question.type === 'mc' ? 'Multiple Choice' : 'Free Response';
            marksBadge.textContent = question.marks === 1 ? '1 Mark' : `${question.marks} Marks`;

            // Display question text
            questionText.textContent = question.text;

            // Display answer interface based on question type
            if (question.type === 'mc') {
                displayMultipleChoice(question);
            } else {
                displayFreeResponse(question);
            }

            // Start timer
            startTimer(question);
        }

        // ====================================================================
        // DISPLAY MULTIPLE CHOICE OPTIONS
        // ====================================================================
        function displayMultipleChoice(question) {
            answerArea.innerHTML = '';

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.addEventListener('click', () => selectOption(button, option));
                answerArea.appendChild(button);
            });
        }

        // ====================================================================
        // SELECT OPTION (Multiple Choice)
        // ====================================================================
        function selectOption(button, option) {
            if (hasSubmitted) return;

            // Deselect all options
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Select clicked option
            button.classList.add('selected');
            userAnswer = option;
        }

        // ====================================================================
        // DISPLAY FREE RESPONSE TEXTAREA
        // ====================================================================
        function displayFreeResponse(question) {
            answerArea.innerHTML = '<textarea class="answer-textarea" id="userAnswerText" placeholder="Type your answer here..."></textarea>';

            const textarea = document.getElementById('userAnswerText');
            textarea.addEventListener('input', () => {
                userAnswer = textarea.value;
            });
        }

        // ====================================================================
        // TIMER LOGIC
        // ====================================================================
        function startTimer(question) {
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Calculate time based on question type
            // MC: 90 seconds, FR: 90 seconds * marks
            if (question.type === 'mc') {
                timeRemaining = 90;
            } else {
                timeRemaining = 90 * question.marks;
            }

            updateTimerDisplay();

            // Start countdown
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                // Add warning class when time is running out
                if (timeRemaining <= 30) {
                    timerDisplay.classList.add('warning');
                }

                // Auto-submit when time runs out
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    if (!hasSubmitted) {
                        handleSubmit();
                    }
                }
            }, 1000);
        }

        // ====================================================================
        // UPDATE TIMER DISPLAY
        // ====================================================================
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            if (timeRemaining > 30) {
                timerDisplay.classList.remove('warning');
            }
        }

        // ====================================================================
        // HANDLE SUBMIT
        // ====================================================================
        async function handleSubmit() {
            if (hasSubmitted) return;

            const question = shuffledQuestions[currentQuestionIndex];

            // Check if user has provided an answer
            if (!userAnswer || (typeof userAnswer === 'string' && userAnswer.trim() === '')) {
                alert('Please provide an answer before submitting.');
                return;
            }

            hasSubmitted = true;
            submitBtn.disabled = true;
            clearInterval(timerInterval);

            // Grade based on question type
            if (question.type === 'mc') {
                gradeMultipleChoice(question, userAnswer);
            } else {
                await gradeFreeResponse(question, userAnswer);
            }
        }

        // ====================================================================
        // GRADE MULTIPLE CHOICE
        // ====================================================================
        function gradeMultipleChoice(question, userAnswer) {
            const isCorrect = userAnswer === question.answer;

            // Flash main content area
            if (isCorrect) {
                mainContent.classList.add('flash-correct');
                feedbackArea.className = 'feedback-area show correct';
                feedbackTitle.textContent = '✓ Correct!';
            } else {
                mainContent.classList.add('flash-incorrect');
                feedbackArea.className = 'feedback-area show incorrect';
                feedbackTitle.textContent = '✗ Incorrect';
            }

            // Remove flash animation after it completes
            setTimeout(() => {
                mainContent.classList.remove('flash-correct', 'flash-incorrect');
            }, 500);

            // Show explanation
            feedbackContent.textContent = question.fullAnswer;
        }

        // ====================================================================
        // GRADE FREE RESPONSE (GOOGLE GEMINI API)
        // ====================================================================
        async function gradeFreeResponse(question, userAnswer) {
            // Show loading state
            feedbackArea.className = 'feedback-area show grading';
            feedbackTitle.innerHTML = 'Grading... <span class="loading"></span>';
            feedbackContent.textContent = 'Please wait while your answer is being evaluated by AI.';

            try {
                const response = await gradeWithGemini(userAnswer, question.fullAnswer, question.marks);

                // Display AI feedback AND official marking scheme
                feedbackArea.className = 'feedback-area show correct';
                feedbackTitle.textContent = 'AI Feedback';
                feedbackContent.textContent = `${response}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nOFFICIAL MARKING SCHEME:\n${question.fullAnswer}`;

            } catch (error) {
                // Handle error
                feedbackArea.className = 'feedback-area show incorrect';
                feedbackTitle.textContent = 'Error';
                feedbackContent.textContent = `Failed to grade answer: ${error.message}\n\nOfficial Answer:\n${question.fullAnswer}`;
            }
        }

        // ====================================================================
        // GOOGLE GEMINI API INTEGRATION
        // ====================================================================
        async function gradeWithGemini(userAnswer, fullAnswer, marks) {
            const apiKey = 'AIzaSyA_mVwJEp4TxAU5n7utscfSWbbIeu31TYg';
            const endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

            const headers = {
                'Content-Type': 'application/json',
                'x-goog-api-key': apiKey
            };

            const prompt = `You are an IB Physics examiner. Compare the student's answer to the official answer and provide detailed feedback.

Student's Answer:
${userAnswer}

Official Answer:
${fullAnswer}

Total Marks Available: ${marks}

Provide:
1. Marks awarded (out of ${marks})
2. What was correct
3. What was missing or incorrect
4. Suggestions for improvement

Be fair but rigorous in your grading, following IB marking criteria.`;

            const body = JSON.stringify({
                contents: [
                    {
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ]
            });

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: body
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();

            // Extract the generated text from the Gemini response
            if (data.candidates && data.candidates.length > 0 &&
                data.candidates[0].content &&
                data.candidates[0].content.parts &&
                data.candidates[0].content.parts.length > 0) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('No response from AI');
            }
        }

        // ====================================================================
        // HANDLE NEXT QUESTION
        // ====================================================================
        function handleNext() {
            currentQuestionIndex++;

            // If we've gone through all questions, reshuffle and restart
            if (currentQuestionIndex >= shuffledQuestions.length) {
                if (confirm('You have completed all questions! Would you like to start over?')) {
                    // Filter to only include D.1, D.2, and D.3 questions
                    const filteredQuestions = questions.filter(q =>
                        q.topic === 'D.1' || q.topic === 'D.2' || q.topic === 'D.3'
                    );
                    shuffledQuestions = [...filteredQuestions].sort(() => Math.random() - 0.5);
                    currentQuestionIndex = 0;
                    displayQuestion();
                }
            } else {
                displayQuestion();
            }
        }

        // ====================================================================
        // START APPLICATION
        // ====================================================================
        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
